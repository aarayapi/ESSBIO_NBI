
SELECT  '5'::text AS codigoProceso,
     '1702' AS codigoarchivo,
        /*CASE wl.ownedby_narran
            WHEN 103 THEN '76833300'::text
            WHEN 104 THEN '96963440'::text
            ELSE NULL::text
        END AS rut,*/
	CASE
		WHEN wl.ownedby_narran IS NULL AND wl.ownedby_grifo IS NOT NULL THEN wl.ownedby_grifo
		WHEN wl.ownedby_grifo IS NULL AND wl.ownedby_narran IS NULL THEN wl.ownedby_valv
		ELSE wl.ownedby_narran
	END AS ownedby,
    (date_part('year'::text, CURRENT_DATE) - 1::double precision) || '12'::text AS periodo,			
	CASE
		WHEN wl.proyecto_informado_siss_narran IS NULL AND wl.proyecto_informado_siss_grifo IS NOT NULL THEN wl.proyecto_informado_siss_grifo
		WHEN wl.proyecto_informado_siss_grifo IS NULL AND wl.proyecto_informado_siss_narran IS NULL THEN wl.proyecto_informado_siss_valv
		ELSE wl.proyecto_informado_siss_narran
	END AS "codigoProyecto",
    wl.codigo_sistema_siss_narran AS codigosistema,	
    ( SELECT a.codigo_localidad_siss
           FROM concesionmetro_ap a
          WHERE a.codigo_localidad = wl.codigo_localidad_narran) AS "codigoLocalidad",
	802 AS "tipoObraUrbanizacion",
	1 AS accion, 
	CASE
    	WHEN wl.codigo_sector_narran IS NULL AND wl.codigo_sector_distribucion_grifo IS NOT NULL THEN '800-' || wl.codigo_sector_distribucion_grifo
		WHEN wl.codigo_sector_narran IS NULL AND wl.codigo_sector_distribucion_grifo IS NULL THEN '800-' || wl.codigo_sector_distribucion_valv
		ELSE '800-' ||  wl.codigo_sector_narran		
	END AS "codigoModificar",
		
    0  AS "materialTipoMedidor",
    NULL  AS  "OtroMaterial",	
	wl.nombre AS "NombreSectorRed",
	narran AS "NumeroArranques",
	NULL::integer AS "NumeroMedidores",
    NULL::integer AS "NumeroUniones",	
	wl.ngrifos AS "NumeroGrifos",
	wl.nvalvulas AS "NumeroValvulas"
	FROM ((
	SELECT wl.ownedby as ownedby_narran, wl.proyecto_informado_siss AS proyecto_informado_siss_narran, wl.codigo_sistema_siss AS codigo_sistema_siss_narran, 
		wl.codigo_localidad AS codigo_localidad_narran, 
  wl.codigo_sector_distribucion AS codigo_sector_narran, count(objectid) AS narran FROM vmt_waterline_sb wl   WHERE  wl.assetgroup = 2 AND wl.assettype = 11 
	AND wl.creationdate >= to_date('20240401','YYYYMMDD') 
	--AND wl.creationdate <= to_date('20240415','YYYYMMDD')
  GROUP BY wl.ownedby, wl.proyecto_informado_siss, wl.codigo_sistema_siss, wl.codigo_localidad, wl.codigo_sector_distribucion)vmwl
   LEFT JOIN (SELECT DISTINCT nombre, codigo_sector_distribucion FROM owd.sectoresdistribucion) st
      ON st.codigo_sector_distribucion::text =  vmwl.codigo_sector_narran
FULL JOIN (SELECT count(wgrf.objectid) AS ngrifos, wgrf.codigo_sector_distribucion AS codigo_sector_distribucion_grifo, wgrf.proyecto_informado_siss AS proyecto_informado_siss_grifo, wgrf.ownedby AS ownedby_grifo, wgrf.proyecto_informado_siss, 
		   wgrf.codigo_sistema_siss, wgrf.codigo_localidad FROM vmt_waterdevice_sb wgrf WHERE wgrf.assetgroup = 7 AND wgrf.assettype = 321 
	AND wgrf.creationdate >= to_date('20240401','YYYYMMDD') 
		--AND creationdate <= to_date('20240401','YYYYMMDD') 		
		GROUP BY wgrf.ownedby, wgrf.proyecto_informado_siss, wgrf.codigo_sistema_siss, wgrf.codigo_localidad, wgrf.codigo_sector_distribucion ) wlgrifo
		ON vmwl.codigo_sector_narran::text =  wlgrifo.codigo_sector_distribucion_grifo 	
		AND vmwl.proyecto_informado_siss_narran = wlgrifo.proyecto_informado_siss_grifo
		AND vmwl.ownedby_narran = wlgrifo.ownedby_grifo
		AND vmwl.codigo_sistema_siss_narran = wlgrifo.codigo_sistema_siss
		AND vmwl.codigo_localidad_narran = wlgrifo.codigo_localidad

FULL JOIN (SELECT count(wgrf.objectid) AS nvalvulas, wgrf.codigo_sector_distribucion AS codigo_sector_distribucion_valv, wgrf.proyecto_informado_siss AS proyecto_informado_siss_valv, wgrf.ownedby AS ownedby_valv, wgrf.proyecto_informado_siss, 
		   wgrf.codigo_sistema_siss, wgrf.codigo_localidad FROM vmt_waterdevice_sb wgrf WHERE wgrf.assetgroup = 2 AND wgrf.assettype in (167, 170,172,173,175)
	AND creationdate >= to_date('20240401','YYYYMMDD') 
   --AND creationdate <= to_timestamp('''||to_char(fecha_fin, 'YYYYMMDD HH24:MI:SS')||''', ''YYYYMMDD HH24:MI:SS'')
	GROUP BY wgrf.ownedby, wgrf.proyecto_informado_siss, wgrf.codigo_sistema_siss, wgrf.codigo_localidad, wgrf.codigo_sector_distribucion) wlvalv
	ON vmwl.codigo_sector_narran::text =  wlvalv.codigo_sector_distribucion_valv   
	AND vmwl.proyecto_informado_siss_narran = wlvalv.proyecto_informado_siss_valv
	AND vmwl.ownedby_narran = wlvalv.ownedby_valv
	AND vmwl.codigo_sistema_siss_narran = wlvalv.codigo_sistema_siss
	AND vmwl.codigo_localidad_narran = wlvalv.codigo_localidad) AS wl
	  ORDER by wl.codigo_sector_narran, wl.proyecto_informado_siss_narran	