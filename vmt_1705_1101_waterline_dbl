-- View: owd.vmt_1705_1101_waterline_dbl

DROP MATERIALIZED VIEW IF EXISTS owd.vmt_1705_1101_waterline_dbl;

CREATE MATERIALIZED VIEW IF NOT EXISTS owd.vmt_1705_1101_waterline_dbl
TABLESPACE pg_default
AS
 SELECT 	cm.proyecto_informado_siss,
    cm.codigo_obra,
    cm.id_tramo_conectado,
    cm.creationdate,
        CASE cm.ownedby
            WHEN 103 THEN '76833300'::text
            WHEN 104 THEN '96963440'::text
            ELSE NULL::text
        END AS rut,
    cm.measuredlength,
    cm.objectid,
    cm.gdb_from_date,
    cm.gdb_archive_oid,
    cm.lifecyclestatus,
    cm.codigo_sistema_siss,
    cm.assetgroup,
    cm.assettype,
    cm.lastupdate	
   FROM dblink('dbname=prd_ap port=5432 host=10.56.209.135 user=owd password=E55b10$2021'::text, ' 
     SELECT
	wl.proyecto_informado_siss,
    wl.codigo_obra,
    wl.id_tramo_conectado,
    wl.creationdate,
    wl.ownedby,
    wl.measuredlength,
    wl.objectid,
    wl.gdb_from_date,
    wl.gdb_archive_oid,
    wl.lifecyclestatus,
    wl.codigo_sistema_siss,
    wl.assetgroup,
    wl.assettype,
    wl.lastupdate	
	FROM waterline wl
  WHERE wl.measuredlength is not null AND (wl.gdb_archive_oid IN ( SELECT mb_.gdb_archive_oid
           FROM ( SELECT waterline.gdb_archive_oid,
                    row_number() OVER (PARTITION BY waterline.objectid ORDER BY waterline.gdb_from_date DESC) AS rn,
                    waterline.gdb_is_delete
                   FROM waterline
                  WHERE waterline.gdb_branch_id = 0 AND waterline.gdb_from_date <= ''9999-12-31 23:59:59''::timestamp without time zone) mb_
          WHERE mb_.rn = 1))'::text) cm(proyecto_informado_siss character varying(100), codigo_obra character varying(100), id_tramo_conectado character varying(100), creationdate  timestamp without time zone, ownedby smallint, 
										measuredlength numeric, objectid integer, gdb_from_date timestamp without time zone, gdb_archive_oid integer, 
										lifecyclestatus smallint, codigo_sistema_siss integer, assetgroup integer, 
										assettype smallint, lastupdate timestamp without time zone)
	UNION
 SELECT 'conduccion histÃ³rica'::character varying AS proyecto_informado_siss,
    ch.codigo_conduccion AS codigo_obra,
    '0'::character varying AS id_tramo_conectado,
    to_date('YYYYMMDD'::text, '20000101'::text) AS creationdate,
    ch.rut_empresa::text AS rut,
    ch.longitud AS measuredlength,
    0 AS objectid,
    to_date('YYYYMMDD'::text, '20000711'::text) AS gdb_from_date,
    0 AS gdb_archive_oid,
    32 AS lifecyclestatus,
    ch.sistema AS codigo_sistema_siss,
    1 AS assetgroup,
    1 AS assettype,
    to_date('YYYYMMDD'::text, '20000101'::text) AS lastupdate
   FROM cunduccion_elim_hist ch	WHERE ch.tabla = 1102
	
	
WITH DATA;

ALTER TABLE IF EXISTS owd.vmt_1705_1101_waterline_dbl
    OWNER TO owd;

GRANT ALL ON TABLE owd.vmt_1705_1101_waterline_dbl TO owd;
GRANT SELECT ON TABLE owd.vmt_1705_1101_waterline_dbl TO bd_consulta;